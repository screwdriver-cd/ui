{{#if session.isAuthenticated}}
  {{#if (not session.data.authenticated.isGuest)}}
    <PipelineNav @pipeline={{pipeline}} />
  {{/if}}
{{/if}}

<InfoMessage
  @message={{errorMessage}}
  @type="warning"
  @icon="exclamation-triangle"
  @scmContext={{pipeline.scmContext}}
/>

{{#unless hasAdmins}}
  <BsAlert @type="warning" @dismissible={{false}}>
    <p>
      This repo has no admins, click
      <span class="text-info" onclick={{action "syncAdmins"}}>
        here
      </span>
      to sync from git repo, you must be an admin to do so.
    </p>
  </BsAlert>
{{/unless}}

{{#if (eq syncAdmins "success")}}
  <BsAlert @type="success">
    <p>
      Good job, pipeline's admins are in sync
    </p>
  </BsAlert>
{{/if}}

{{#if (eq syncAdmins "failure")}}
  <BsAlert @type="danger">
    <p>
      Something went wrong, please try syncing again
    </p>
  </BsAlert>
{{/if}}

<div class="row">
  <div class="col-xs-12 col-md-9 separator partial-view">
    <PipelineGraphNav
      @pipeline={{pipeline}}
      @mostRecent={{mostRecent}}
      @latestCommit={{latestCommit}}
      @lastSuccessful={{lastSuccessful}}
      @graphType={{currentEventType}}
      @selectedEvent={{selectedEvent}}
      @selectedEventObj={{selectedEventObj}}
      @selected={{selected}}
      @showListView={{showListView}}
      @showDownstreamTriggers={{showDownstreamTriggers}}
      @setDownstreamTrigger={{action "setDownstreamTrigger"}}
      @startMainBuild={{action "startMainBuild"}}
      @startPRBuild={{action "startPRBuild"}}
      @prGroups={{pullRequestGroups}}
      @stopEvent={{action "stopEvent"}}
      @setShowListView={{action "setShowListView"}}
    />

    <PipelineWorkflow
      @jobId={{jobId}}
      @pipeline={{pipeline}}
      @latestCommit={{latestCommit}}
      @showDownstreamTriggers={{showDownstreamTriggers}}
      @showPRJobs={{showPRJobs}}
      @completeWorkflowGraph={{completeWorkflowGraph}}
      @workflowGraph={{pipeline.workflowGraph}}
      @jobs={{jobs}}
      @prJobs={{prJobs}}
      @selectedEventObj={{selectedEventObj}}
      @selected={{selected}}
      @startDetachedBuild={{action "startDetachedBuild"}}
      @stopBuild={{action "stopBuild"}}
      @setJobState={{action "setJobState"}}
      @authenticated={{session.isAuthenticated}}
    />
  </div>
  <div
    class="col-xs-12 col-md-3 no-padding column-tabs-view partial-view
      {{if showListView "disabled"}}"
    onScroll={{action "onEventListScroll"}}
  >
    <BsTab @customTabs={{true}} as |tab|>
      <BsNav @type="tabs" as |nav|>
        <nav.item @active={{bs-eq activeTab "events"}}>
          {{#nav.link-to "pipeline.events" class="nav-link"}}
            Events
          {{/nav.link-to}}
        </nav.item>
        <nav.item @active={{bs-eq activeTab "pulls"}}>
          {{#nav.link-to "pipeline.pulls" class="nav-link"}}
            Pull Requests
          {{/nav.link-to}}
        </nav.item>
      </BsNav>

      <div class="tab-content">
        <tab.pane @activeId={{activeTab}} @id="events" @title="Events">
          <PipelineEventsList
            @pipeline={{pipeline}}
            @expandedEventsGroup={{expandedEventsGroup}}
            @events={{events}}
            @selected={{mut selected}}
            @selectedEvent={{selectedEvent}}
            @selectedEventObj={{selectedEventObj}}
            @latestCommit={{latestCommit}}
            @lastSuccessful={{lastSuccessful}}
            @mostRecent={{mostRecent}}
            @eventsPage={{eventsPage}}
            @startPRBuild={{action "startPRBuild"}}
            @stopEvent={{action "stopEvent"}}
            @updateEvents={{action "updateEvents"}}
          />
          <div
            style="padding: 20px;"
            onMouseEnter={{action "onEventListScroll"}}
          ></div>
        </tab.pane>
        <tab.pane @activeId={{activeTab}} @id="pulls" @title="Pull Requests">
          {{#if prChainEnabled}}
            <PipelineEventsList
              @pipeline={{pipeline}}
              @expandedEventsGroup={{expandedEventsGroup}}
              @events={{events}}
              @selected={{mut selected}}
              @selectedEventObj={{selectedEventObj}}
              @selectedEvent={{selectedEvent}}
              @latestCommit={{latestCommit}}
              @lastSuccessful={{lastSuccessful}}
              @eventsPage={{eventsPage}}
              @startPRBuild={{action "startPRBuild"}}
              @stopEvent={{action "stopEvent"}}
              @updateEvents={{action "updateEvents"}}
            />
          {{else}}
            {{#each pullRequestGroups as |prg|}}
              <PipelinePrList
                @jobs={{prg}}
                @pipeline={{pipeline}}
                @selected={{mut selected}}
                @selectedEvent={{selectedEvent}}
                @isRestricted={{isRestricted}}
                @startBuild={{action "startPRBuild"}}
                @stopPRBuilds={{action "stopPRBuilds"}}
                @workflowGraph={{pipeline.workflowGraph}}
              />
            {{else}}
              <div class="alert">
                No open pull requests
              </div>
            {{/each}}
          {{/if}}
        </tab.pane>
      </div>
    </BsTab>
  </div>
</div>

{{#if isShowingModal}}
  <ModalDialog
    @clickOutsideToClose={{false}}
    @targetAttachment="center"
    @translucentOverlay={{true}}
  >
    <LoadingView />
  </ModalDialog>
{{/if}}

{{outlet}}